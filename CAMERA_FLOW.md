# ğŸ“· ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ - è©³ç´°ãƒ•ãƒ­ãƒ¼å›³

## ã‚«ãƒ¡ãƒ©èµ·å‹•ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    Start([ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒğŸ“·ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯])
    
    Start --> Check{HTTPSç’°å¢ƒ?}
    
    Check -->|No: HTTP| ErrorMsg[ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º<br/>âŒ ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã¯HTTPSæ¥ç¶šã§ã®ã¿åˆ©ç”¨å¯èƒ½]
    Check -->|Yes: HTTPS| GetMedia[getUserMedia APIã‚’å‘¼ã³å‡ºã—]
    
    ErrorMsg --> End1([å‡¦ç†çµ‚äº†])
    
    GetMedia --> Try1{èƒŒé¢ã‚«ãƒ¡ãƒ©å–å¾—è©¦è¡Œ}
    
    Try1 -->|æˆåŠŸ| Success1[èƒŒé¢ã‚«ãƒ¡ãƒ©å–å¾—æˆåŠŸ âœ…]
    Try1 -->|å¤±æ•—| Try2{å‰é¢ã‚«ãƒ¡ãƒ©å–å¾—è©¦è¡Œ}
    
    Try2 -->|æˆåŠŸ| Success2[å‰é¢ã‚«ãƒ¡ãƒ©å–å¾—æˆåŠŸ âœ…]
    Try2 -->|å¤±æ•—| Try3{ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¡ãƒ©å–å¾—è©¦è¡Œ}
    
    Try3 -->|æˆåŠŸ| Success3[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¡ãƒ©å–å¾—æˆåŠŸ âœ…]
    Try3 -->|å…¨å¤±æ•—| Error2[ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼è¡¨ç¤º âŒ]
    
    Success1 --> StreamOK[ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ]
    Success2 --> StreamOK
    Success3 --> StreamOK
    
    StreamOK --> SetState[setCameraActive true]
    
    Error2 --> End2([å‡¦ç†çµ‚äº†])
    
    SetState --> ShowUI[ã‚«ãƒ¡ãƒ©ç”»é¢ã‚’è¡¨ç¤º<br/>fixed overlay z-50]
    
    ShowUI --> WaitUser([ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’å¾…æ©Ÿ])
    
    WaitUser --> Shot{æ’®å½±ãƒœã‚¿ãƒ³}
    WaitUser --> Cancel{ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³}
    
    Shot --> Capture[ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£]
    Cancel --> Stop[ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢]
    
    Capture --> Draw[Canvasã«æç”»]
    Draw --> Jpeg[JPEGå½¢å¼ã«å¤‰æ›]
    Jpeg --> CloseUI[ã‚«ãƒ¡ãƒ©ç”»é¢ã‚’é–‰ã˜ã‚‹]
    CloseUI --> OCR[OCRå‡¦ç†é–‹å§‹]
    
    Stop --> End3([å‡¦ç†çµ‚äº†])
    OCR --> End4([å‡¦ç†çµ‚äº†])
    
    style Start fill:#90EE90
    style ShowUI fill:#87CEEB
    style WaitUser fill:#FFD700
    style ErrorMsg fill:#FFB6C1
    style Error2 fill:#FFB6C1
```

## ç”»é¢é·ç§»ã®è©³ç´°

### âœ… ãƒšãƒ¼ã‚¸é·ç§»ã¯**ã—ã¾ã›ã‚“**ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as ğŸ–¥ï¸ ãƒ¡ã‚¤ãƒ³ç”»é¢
    participant Modal as ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«
    participant Video as ğŸ¥ Videoè¦ç´ 
    participant API as ğŸ” OCR API
    
    Note over UI: é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆç”»é¢è¡¨ç¤ºä¸­
    Note over UI: cameraActive = false
    
    User->>UI: ğŸ“·ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    UI->>UI: startCamera()å‘¼ã³å‡ºã—
    
    alt HTTTPç’°å¢ƒã®å ´åˆ
        UI->>UI: navigator.mediaDevicesãŒnull
        UI-->>User: âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    else HTTPSç’°å¢ƒã®å ´åˆ
        UI->>Video: getUserMedia()ã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹
        Video-->>UI: MediaStreamå–å¾—æˆåŠŸ
        
        UI->>UI: setCameraActive(true)
        UI->>Modal: ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        Note over Modal: position: fixed<br/>inset-0<br/>z-50<br/>å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        
        Modal->>User: ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’è¡¨ç¤º
        Note over User,Modal: é»’èƒŒæ™¯ + ç´«è‰²ã®æ ã‚¬ã‚¤ãƒ‰
        
        alt ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ’®å½±ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
            User->>Modal: ğŸ“¸ æ’®å½±ãƒœã‚¿ãƒ³
            Modal->>Video: capturePhoto()
            Video->>Video: Canvasã«æç”»
            Video->>Video: JPEGå¤‰æ›
            Modal->>UI: stopCamera()
            UI->>UI: setCameraActive(false)
            Modal-->>User: ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
            UI->>API: OCRå‡¦ç†é–‹å§‹
            API-->>User: çµæœè¡¨ç¤º
        else ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
            User->>Modal: âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            Modal->>UI: stopCamera()
            UI->>UI: setCameraActive(false)
            Modal-->>User: ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        end
    end
```

## UIæ§‹é€ ã®è©³ç´°

### é€šå¸¸ç”»é¢ï¼ˆcameraActive = falseï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“· ã‚«ãƒ¡ãƒ©èªè¨¼AI         æ›¸é¡èªè¨¼ãƒ»ãƒ‡ãƒ¼ã‚¿æŠ½å‡º     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  ğŸ¤– ã“ã‚“ã«ã¡ã¯ï¼ã‚«ãƒ¡ãƒ©èªè¨¼AIã§ã™ã€‚              â”‚
â”‚     ğŸ“‹ æ‰‹é †:                                    â”‚
â”‚     1. CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰...            â”‚
â”‚                                                 â”‚
â”‚  ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...                       â”‚
â”‚                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [èª­ã¿è¾¼ã¿å®Œäº†]  ğŸ“·  ğŸ“  [å…¥åŠ›]  â¡ï¸          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚«ãƒ¡ãƒ©ç”»é¢è¡¨ç¤ºæ™‚ï¼ˆcameraActive = trueï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
â”‚ â–ˆ                                             â–ˆ â”‚
â”‚ â–ˆ   ğŸ“„ æ›¸é¡ã‚’æ å†…ã«é…ç½®ã—ã¦ãã ã•ã„              â–ˆ â”‚
â”‚ â–ˆ                                             â–ˆ â”‚
â”‚ â–ˆ       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â–ˆ â”‚
â”‚ â–ˆ       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â–ˆ â”‚
â”‚ â–ˆ   â–“â–“â–“ â”‚ â”‚                  â”‚ â”‚ â–“â–“â–“â–“        â–ˆ â”‚
â”‚ â–ˆ   â–“â–“â–“ â”‚ â”‚   ã‚«ãƒ¡ãƒ©æ˜ åƒ      â”‚ â”‚ â–“â–“â–“â–“        â–ˆ â”‚
â”‚ â–ˆ   â–“â–“â–“ â”‚ â”‚  (ç´«è‰²ã®æ ã‚¬ã‚¤ãƒ‰) â”‚ â”‚ â–“â–“â–“â–“        â–ˆ â”‚
â”‚ â–ˆ   â–“â–“â–“ â”‚ â”‚                  â”‚ â”‚ â–“â–“â–“â–“        â–ˆ â”‚
â”‚ â–ˆ       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â–ˆ â”‚
â”‚ â–ˆ       â”‚ ã“ã“ã«æ–‡å­—ã‚’åˆã‚ã›ã¦    â”‚              â–ˆ â”‚
â”‚ â–ˆ       â”‚    ãã ã•ã„          â”‚              â–ˆ â”‚
â”‚ â–ˆ       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â–ˆ â”‚
â”‚ â–ˆ                                             â–ˆ â”‚
â”‚ â–ˆ               [ğŸ“¸]  [âŒ]                    â–ˆ â”‚
â”‚ â–ˆ                                             â–ˆ â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘ å…¨ç”»é¢å›ºå®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆz-50ï¼‰
```

## ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œé †åº

```javascript
// 1. ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
onClick={startCamera}

// 2. ã‚«ãƒ¡ãƒ©èµ·å‹•é–¢æ•°
const startCamera = async () => {
  // 2-1. HTTPSãƒã‚§ãƒƒã‚¯
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º â†’ çµ‚äº†
    return;
  }
  
  // 2-2. ã‚«ãƒ¡ãƒ©å–å¾—ï¼ˆ3æ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: "environment" }  // èƒŒé¢
    });
  } catch (e1) {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "user" }  // å‰é¢
      });
    } catch (e2) {
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: true  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      });
    }
  }
  
  // 2-3. Videoè¦ç´ ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ è¨­å®š
  videoRef.current.srcObject = stream;
  streamRef.current = stream;
  
  // 2-4. Stateæ›´æ–° â†’ UIè¡¨ç¤º
  setCameraActive(true);
}

// 3. Stateæ›´æ–°ã«ã‚ˆã‚Šãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
{cameraActive && (
  <div className="fixed inset-0 bg-black z-50">
    <video ref={videoRef} autoPlay playsInline muted />
    {/* ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³UI */}
    <button onClick={capturePhoto}>ğŸ“¸</button>
    <button onClick={stopCamera}>âŒ</button>
  </div>
)}

// 4. æ’®å½±å‡¦ç†
const capturePhoto = () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  const url = canvas.toDataURL("image/jpeg", 0.95);
  stopCamera();
  processImage(url);  // OCRå‡¦ç†é–‹å§‹
}
```

## é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

### âœ… ãƒšãƒ¼ã‚¸é·ç§»ãªã—
- `cameraActive` stateã§åˆ¶å¾¡
- `position: fixed, inset-0, z-50`ã§å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
- **URLã¯å¤‰æ›´ã—ãªã„**

### ğŸ“ Stateç®¡ç†
```javascript
const [cameraActive, setCameraActive] = useState(false);

// false â†’ true: ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
// true â†’ false: ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
```

### ğŸ¯ ãƒ¡ã‚¤ãƒ³ç”»é¢ã¨ã®é–¢ä¿‚
```
é€šå¸¸ç”»é¢: ãƒãƒ£ãƒƒãƒˆå±¥æ­´ + å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
     â†“
ğŸ“·ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
     â†“
å…¨ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºï¼ˆé€šå¸¸ç”»é¢ã®ä¸Šã«é‡ã­ã‚‹ï¼‰
     â†“
ã‚«ãƒ¡ãƒ©æ˜ åƒ + æ’®å½±ãƒœã‚¿ãƒ³
     â†“
æ’®å½±å®Œäº† or ã‚­ãƒ£ãƒ³ã‚»ãƒ«
     â†“
å…ƒã®é€šå¸¸ç”»é¢ã«æˆ»ã‚‹ï¼ˆURLå¤‰ã‚ã‚‰ãšï¼‰
```

## ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ

### ğŸ“± iOS Safari
- âœ… `playsInline` â†’ ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å†ç”Ÿ
- âœ… `muted` â†’ éŸ³å£°ã‚ªãƒ•ï¼ˆå¿…é ˆï¼‰
- âš ï¸ `facingMode` éå¯¾å¿œå¯èƒ½æ€§ â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚ã‚Š

### ğŸ¤– Android Chrome
- âœ… ã™ã¹ã¦ã®æ©Ÿèƒ½å¯¾å¿œ
- âœ… `facingMode: "environment"` ã§èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆ

### ğŸ’» PC Chrome/Safari
- âœ… ã™ã¹ã¦ã®æ©Ÿèƒ½å¯¾å¿œ
- âœ… `facingMode: "environment"` ã¯ç„¡è¦–ã•ã‚Œã‚‹

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³1: HTTTPç’°å¢ƒ
```
âŒ ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã¯HTTPSæ¥ç¶šã§ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
ç¾åœ¨HTTPã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚
```

### ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã‚«ãƒ¡ãƒ©æ¨©é™æ‹’å¦
```
âŒ ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚
```

### ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚«ãƒ¡ãƒ©æœªæ¥ç¶š
```
âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: [ã‚¨ãƒ©ãƒ¼è©³ç´°]
```

## ã¾ã¨ã‚

| é …ç›® | è©³ç´° |
|------|------|
| **ãƒšãƒ¼ã‚¸é·ç§»** | âŒ ãªã—ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰ |
| **ç”»é¢æ§‹é€ ** | å…¨ç”»é¢å›ºå®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ |
| **URLå¤‰æ›´** | âŒ å¤‰æ›´ãªã— |
| **Stateç®¡ç†** | `cameraActive` boolean |
| **çµ‚äº†æ–¹æ³•** | æ’®å½±å®Œäº† or ã‚­ãƒ£ãƒ³ã‚»ãƒ« |
| **HTTPSå¿…é ˆ** | âœ… å¿…é ˆ |


